# 美容室顧客データリピート分析 要件定義書

## 1. はじめに

本文書は、美容室の顧客データを用いて、特定期間の新規顧客のリピート状況を多角的に分析し、その結果をインタラクティブなダッシュボード形式で可視化するためのシステム（以下、本システム）の要件を定義するものです。この分析を通じて、顧客の定着度を詳細に把握し、マーケティング施策の最適化、サービス改善、スタイリスト育成、目標管理等に役立てることを目指します。

## 2. 目的

- ユーザーが指定した**新規顧客抽出期間**に来店した新規顧客を特定する。
- 上記の新規顧客が、ユーザーが指定した**リピート集計期間の終了日**までに何回リピート来店したかを分析する。
- リピート状況を様々な角度（全体、リピート段階、スタイリスト別、クーポン別、目標値比較など）から分析し、ダッシュボードに分かりやすく表示する。
- 分析結果（数値、グラフ、インサイト）を基に、顧客維持・育成戦略の立案と効果測定を支援する。
- 店舗運営におけるKPI設定とその達成度をモニタリングする。

## 3. 分析対象

### 3.1. 対象データ

- 来店履歴データ。データはCSVファイル群として提供される。
- データ形式はCSVファイルとする。

### 3.2. 新規顧客の定義

- ユーザーが指定した**新規顧客抽出期間**内に初めて来店し、かつ以下の条件を全て満たす顧客:
    1. CSVファイルの「このサロンに行くのは初めてですか？」カラムの値が「はい、初めてです」である。
    2. CSVファイルの「ステータス」カラムの値が「済み」である（実際にサービスを受け、会計が完了した来店）。

### 3.3. リピート顧客の定義

- 上記3.2で定義された新規顧客が、初回の有効な来店日（ステータス「済み」）**以降**、ユーザーが指定した**リピート集計期間の終了日**までに、再度有効な来店（ステータス「済み」）をした場合をリピートとする。
    - 初回来店はリピート回数に含めない (0回目)。
    - 2回目の来店が初回リピート (リピート1回目)。

## 4. 分析項目と指標 (ダッシュボード表示およびレポート出力項目)

### 4.1. 顧客リピート状況概要 (ダッシュボード最上部)

- **新規顧客総数**: 新規顧客抽出期間内の総新規顧客数。
- **X回以上リピーター数**: リピート集計期間内にX回以上リピートした新規顧客の数 (Xはデフォルト3回)。
- **X回以上リピート率**: (X回以上リピーター数 / 新規顧客総数) \* 100。
- **初回リピート率**: (1回以上リピートした新規顧客数 / 新規顧客総数) \* 100。

### 4.2. リピートファネル分析

- **4.2.1. リピートステージ分析について (説明文)**:
    - 「このセクションでは、顧客が各来店段階（新規来店、2回目来店、3回目来店など）でどのように推移していくかを分析しています。」
    - 「ステージ間の継続率: 前段階から次の段階へ進んだ顧客の割合です。この値が高いほど顧客維持が成功していることを示します。」
- **4.2.2. リピートステージ別顧客数と割合 (棒グラフ)**:
    - X軸: 来店ステージ (新規来店, 2回目来店(初回リピート), 3回目来店(2回目リピート), 4回目来店(3回目リピート), 5回目来店(4回目リピート))。
    - Y軸: 顧客数。
    - 各棒の上に顧客数と、新規顧客総数に対する割合 (%) を表示。
- **4.2.3. ステージ間の継続率 (前ステージからの継続率) (棒グラフ)**:
    - X軸: 来店ステージ (2回目来店(初回リピート), 3回目来店(2回目リピート), 4回目来店(3回目リピート)。
    - Y軸: 継続率 (%)。
    - 各棒の上に継続率 (%) を表示。
    - 計算式例 (3回目来店継続率): (3回目来店顧客数 / 2回目来店顧客数) \* 100。
- **4.2.4. リピート回数分布と累積割合 (複合グラフ: 棒グラフ + 折れ線グラフ)**:
    - X軸: リピート回数 (0回, 1回, 2回, 3回, 4回, 5回, 6回, 7回, 8回, 9回以上など)。
    - Y1軸 (左): 顧客数 (棒グラフ)。
    - Y2軸 (右): 累積割合 (%) (折れ線グラフ)。
    - 各棒の上に顧客数を表示。

### 4.3. スタイリスト別リピート分析

- **4.3.1. スタイリスト別リピート分析について (説明文)**:
    - 「このセクションでは、各スタイリストの顧客維持能力を分析しています。」
    - 「X回以上リピート率: 各スタイリストが初回担当した顧客のうち、X回以上リピートした（合計X+1回以上来店した）顧客の割合です。」(Xはデフォルト3回)
    - 「トップスタイリスト: X回以上リピート率が最も高いスタイリストです。」
    - 「優秀スタイリスト: X回以上リピーターをY人以上獲得しているスタイリストです。」(Yはデフォルト10人)
    - 「※新規顧客数が少ないスタイリスト（Z人未満）は比較対象から除外しています。」(Zはデフォルト10人)
- **4.3.2. サマリー指標**:
    - **X回以上リピート率の最高値**: スタイリストの中で最も高いX回以上リピート率。
    - **トップスタイリスト**: 上記最高値を記録したスタイリスト名（複数いる場合は併記または代表者）。「スタイリスト名」カラムが空白または「不明」の場合はその旨を表示。
    - **X回以上リピーター数 (全体)**: 全スタイリストが担当した新規顧客のうち、X回以上リピートした総顧客数。
- **4.3.3. スタイリスト別 X回以上リピート率 (新規顧客Z人以上) (横棒グラフ)**:
    - Y軸: スタイリスト名 (X回以上リピート率の高い順にソート)。「スタイリスト名」カラムが空白または「不明」も1つのカテゴリとして集計。
    - X軸: X回以上リピート率 (%)。
    - 各棒の右端に率 (%) を表示。
    - ツールチップで担当新規顧客数、X回以上リピート顧客数を表示。
    - 新規担当顧客数がZ人未満のスタイリストは表示対象外とする。
- **4.3.4. スタイリスト別初回リピート率 (オプション)**:
    - 同様のグラフ形式で表示。

### 4.4. クーポン別リピート分析

- **4.4.1. クーポン別リピート分析について (説明文)**:
    - 「このセクションでは、初回来店時に使用されたクーポンと顧客リピート状況を分析しています。」
    - 「X回以上リピート率: あるクーポンを初回来店時に利用した顧客のうち、X回以上リピートした（合計X+1回以上来店した）顧客の割合です。」 (Xはデフォルト3回)
    - 「最も効果的なクーポン: X回以上リピート率が最も高いクーポンです。」
    - 「この分析により、どのクーポンで来店した顧客が最も継続して来店するかを判断でき、効果的なクーポン施策の立案に役立ちます。」
    - 「※利用顧客数が少ないクーポン（Z人未満）は比較対象から除外しています。」 (Zはデフォルト5人)
- **4.4.2. サマリー指標**:
    - **最も効果的なクーポン**: X回以上リピート率が最も高いクーポン名（「予約時HotPepperBeautyクーポン」など）。
    - **上記クーポンのX回以上リピート率 (%)**
    - **上記クーポンの平均リピート回数** (リピートした顧客のみ対象、初回来店含まず)
- **4.4.3. クーポン別 X回以上リピート率 (新規顧客Z人以上) (横棒グラフ)**:
    - Y軸: クーポン名 (X回以上リピート率の高い順にソート)。
    - X軸: X回以上リピート率 (%)。
    - 各棒の右端に率 (%) を表示。
    - ツールチップで利用顧客数、X回以上リピート顧客数を表示。
    - 利用顧客数がZ人未満のクーポンは表示対象外とする。
- **4.4.4. クーポン別 平均リピート回数 (新規顧客Z人以上) (横棒グラフ)**:
    - Y軸: クーポン名 (平均リピート回数の多い順にソート)。
    - X軸: 平均リピート回数。
    - 各棒の右端に回数を表示。

### 4.5. 目標値比較分析

- **4.5.1. 目標値比較分析について (説明文)**:
    - 「このセクションでは、店舗が設定したリピート率の目標値と実績を比較し、目標達成に必要な具体的な顧客数を分析しています。」
- **4.5.2. 目標値の設定 (UI入力項目)**:
    - 初回リピート率 目標値 35(%)
    - 2回目リピート率 目標値45 (%) (3回目来店/2回目来店)
    - 3回目リピート率 目標値 60(%) (4回目来店/3回目来店)
- **4.5.3. リピート段階別 目標と実績 (複合グラフ: 棒グラフ)**:
    - X軸: リピート段階 (初回リピート, 2回目リピート, 3回目リピート, X回以上リピート)。
    - Y軸: リピート率 (%)。
    - 各段階で「実績」(青棒)と「目標値」(赤棒)を並べて表示。
- **4.5.4. 分析コメント (テキスト表示)**:
    - 「全体として目標達成率はXX.X%です。さらなる改善の余地があります。」
    - 「最も改善が必要な段階: 初回リピート率 (実績: XX.X%, 目標: YY.Y%, 目標達成率: ZZ.Z%)」
- **4.5.5. 実績と目標値の比較 (テーブル)**:
    - 行: リピート段階
    - 列: 目標値(%), 実績値(%), 目標達成率(%)
- **4.5.6. 目標達成に必要な追加顧客数 (テーブル)**:
    - 行: リピート段階
    - 列: 目標顧客数, 現在の顧客数, 追加で必要な顧客数
    - 計算例 (初回リピート):
        - 目標初回リピート顧客数 = 新規顧客総数 \* (初回リピート率目標値 / 100)
        - 追加で必要な初回リピート顧客数 = 目標初回リピート顧客数 - 現在の初回リピート顧客数

### 4.6. その他サマリーレポート項目

- **4.6.1. 全体集計**:
    - 新規顧客総数
    - リピーター総数 (1回以上リピートした顧客)
    - 全体リピート率 (リピーター総数 / 新規顧客総数) \* 100
    - 平均リピート回数 (全新規顧客ベース): 総リピート来店数 / 新規顧客総数
    - 平均リピート回数 (リピーターのみ): 総リピート来店数 / リピーター総数
- **4.6.2. 月別新規顧客数**:
    - 新規顧客抽出期間内の各月ごとの新規顧客数。
- **4.6.3. 月別初回リピート率**:
    - 新規顧客抽出期間内の各月に獲得した新規顧客が、リピート集計期間の終了日までに初回リピートした割合。
- **4.6.4. リピートまでの期間分析**:
    - 平均初リピート日数 (初回リピートした顧客の、初回来店日から初回リピート日までの平均日数)。
    - 中央値初リピート日数。
    - 最短初リピート日数。
    - 最長初リピート日数。
- **4.6.5. 初回リピートまでの期間区分ごとのリピーター数と割合**:
    - 30日以内, 31-60日, 61-90日, 91-180日, 181-365日, 365日超
    - 各期間で初回リピートした顧客数と、全初回リピーター数に対する割合 (%)。

## 5. 分析手法 (Python)

### 5.1. Pythonバージョン

- Python 3.12 (または互換性のある最新安定版)

### 5.2. データ処理フロー (Flask Webアプリケーションバックエンド)

1. **データ読み込みと前処理**:
    - UIから指定されたサロンのCSVファイルを全て読み込み、Pandasデータフレームに結合。
    - ファイルエンコーディングは `utf-8-sig` を試行し、失敗した場合は `cp932` (shift-jis) 等も考慮。
    - 「来店日」カラムをdatetime型に変換。不正な値はエラーログ出力または除外。
    - 6.2. データクレンジング方針に基づき、データ整形。
2. **顧客の同定**:
    - 顧客を一意に識別するためのキー（顧客ID）を生成。6.2の方針に従い、電話番号、氏名（フリガナ＋漢字、カナ＋漢字）を正規化し、優先順位で結合。
3. **新規顧客リスト作成**:
    - 結合・クレンジングされたデータから、ユーザー指定の**新規顧客抽出期間**内の来店記録を抽出。
    - 3.2.の新規顧客定義に合致する顧客を顧客IDベースでリストアップし、初回来店日を特定。
4. **リピート分析**:
    - 新規顧客リストに基づき、各顧客の初回来店日以降の有効な来店履歴（ステータス「済み」）を、リピート集計期間の終了日までの全データから抽出。
    - 各新規顧客の来店日を時系列にソートし、初回来店日以降の来店回数をリピート回数としてカウント。
5. **集計と分析結果生成**:
    - 4.で定義された各分析項目と指標を計算。
    - リピートファネル分析: 各ステージの顧客数を集計し、継続率を算出。
    - スタイリスト/クーポン別分析: 初回来店時の担当スタイリスト/利用クーポンで新規顧客をグループ化し、各グループのリピート状況を集計。フィルタリング条件（最低新規顧客数）を適用。
    - 目標値比較分析: UIからの目標値と実績値を比較し、達成率、必要顧客数を計算。
    - 期間分析: 初回リピート顧客の初回来店日と初回リピート日の差分を計算し、統計量を算出。
6. **出力 (Flask Web UIへのデータ提供およびレポート生成)**:
    - 計算された指標、グラフ描画用データ（Chart.jsやPlotlyに適したJSON形式）、テーブル表示用データをフロントエンドに提供。
    - サマリーレポート.txt に記載の形式でテキストレポートを生成可能にする (オプションでファイル出力)。

## 6. データ要件

### 6.1. 入力データ (CSVファイル)

- ファイルエンコーディング: `utf-8-sig` (推奨), `cp932` (代替)
- 主要カラム :
    - `ステータス`: 予約状態 (例: `済み`)
    - `予約番号`
    - `キャンセル料`
    - `スタイリスト名`: 空白、「不明」の場合あり。
    - `指名予約有無`
    - `来店日`: YYYYMMDD形式
    - `開始時間`, `終了時間`: HHMM形式
    - `施術時間`
    - `第一来店希望日`, `開始時間`, `終了時間`, `第二来店希望日` (リピート分析では主に`来店日`を使用)
    - `予約経路`
    - `支払い種別`
    - `予約時メニューカテゴリ`
    - `予約時メニュー`
    - `予約時HotPepperBeautyクーポン`
    - `予約時HotPepperBeautyクーポンカテゴリ`
    - `施術目安時間`
    - `予約時他経路の割引・サービス・オプション`
    - `予約時キャンセル規定`
    - `フリガナ`, `お名前`
    - `電話番号` (2列あるが、同一顧客であれば同じ番号が入ることを期待。例: 9088575185)
    - `性別` (2列あるが、同一顧客であれば同じ性別が入ることを期待)
    - `氏名(カナ)`, `氏名(漢字)`
    - `お客様番号`: 空白、POS+数字、m+数字、指数表記(例: 9.92401E+13)など多様。顧客同定の補助として使用。
    - `予約時合計金額`, `予約時利用ポイント`, `お支払い予定金額`, `付与予定ポイント`, `来店処理金額`, `付与ポイント`, `会計時合計金額`, `会計時利用ポイント`
    - `ランク`
    - `カウンセリングで知りたいこと`, `接客への希望`, `料金`, `ご要望・ご相談`, `好きなファッション雑誌`, `サロンからのお客様への質問`, `なりたいスタイルURL`, `予約時ご要望`, `次回来店向けメモ`
    - `転記チェック`
    - `このサロンに行くのは初めてですか？`: (例: `はい、初めてです`, `いいえ、以前行ったことがあります`)
    - `ご来店に際しての注意事項`
    - `会計時メニューカテゴリ`, `会計時メニュー`, `会計時店販カテゴリ`, `会計時店販`, `会計時HotPepperBeautyクーポンカテゴリ`, `会計時HotPepperBeautyクーポン`, `会計時他経路の割引・サービス・オプション`

### 6.2. データクレンジング方針

- **顧客識別キーの整備**:
    - 電話番号: 2列ある「電話番号」は内容を比較し、不一致の場合はログ出力。原則として1列目を優先。非数値文字（ハイフン等）を除去。
    - 氏名関連: 全角/半角スペース除去。カタカナは全角に統一。
    - お客様番号: 指数表記は可能な限り数値に変換。文字列として扱い、他のキーとの組み合わせで使用。
- **欠損値の扱い**:
    - 顧客同定キーが全て欠損しているレコードは除外。
    - 「このサロンに行くのは初めてですか？」カラム欠損は新規顧客判定不可のため、該当期間の新規顧客としては扱わない。
    - 「来店日」欠損または不正な日付は除外。
    - 「スタイリスト名」空白は「不明」または「担当者なし」として扱う。
- **ステータスの処理**: 「済み」以外は来店実績としない。
- **日付・時刻**: 「来店日」は `YYYYMMDD` をdatetimeに。「開始時間」「終了時間」は `HHMM` を時刻情報としてパース。

## 7. システム要件

- Python: バージョン 3.12
- 主要ライブラリ:
    - Flask: Webアプリケーションフレームワーク
    - Pandas: データ操作・分析
    - NumPy: 数値計算
    - Matplotlib, Seaborn, Plotly (いずれか、または組み合わせ): グラフ描画