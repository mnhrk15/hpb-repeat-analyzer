{% extends "base.html" %}

{% block title %}ダッシュボード - 美容室顧客データリピート分析システム{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-1">リピート分析ダッシュボード</h1>
                    <p class="text-muted mb-0">
                        分析期間: {{ parameters.new_customer_start }} ～ {{ parameters.new_customer_end }}
                        （リピート集計終了: {{ parameters.repeat_analysis_end }}）
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-primary" onclick="window.print()">
                        <i class="fas fa-print me-1"></i>印刷
                    </button>
                    <button type="button" class="btn btn-success" onclick="Export.downloadReport()">
                        <i class="fas fa-download me-1"></i>レポート出力
                    </button>
                    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>戻る
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        {% for card in data.summary_cards %}
        <div class="col-md-3 col-sm-6">
            <div class="card summary-card bg-{{ card.color }} border-0 position-relative">
                <div class="card-body">
                    <div class="card-title">{{ card.title }}</div>
                    <div class="card-value">{{ card.value }}</div>
                    <div class="card-unit">{{ card.unit }}</div>
                    <i class="fas fa-{{ card.icon }} card-icon"></i>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Funnel Analysis Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-funnel-dollar me-2"></i>
                        リピートファネル分析
                    </h3>
                    <p class="section-description">
                        このセクションでは、顧客が各来店段階（新規来店、2回目来店、3回目来店など）でどのように推移していくかを分析しています。
                        ステージ間の継続率: 前段階から次の段階へ進んだ顧客の割合です。この値が高いほど顧客維持が成功していることを示します。
                    </p>
                </div>
                
                <div class="card-body">
                    <div class="row">
                        <!-- Stage Chart -->
                        <div class="col-lg-6">
                            <div class="chart-container" id="stageChartContainer">
                                <h5 class="chart-title">リピートステージ別顧客数</h5>
                                <canvas id="stageChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Continuation Rate Chart -->
                        <div class="col-lg-6">
                            <div class="chart-container" id="continuationChartContainer">
                                <h5 class="chart-title">ステージ間継続率</h5>
                                <canvas id="continuationChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Distribution Chart -->
                        <div class="col-12">
                            <div class="chart-container" id="distributionChartContainer">
                                <h5 class="chart-title">リピート回数分布と累積割合</h5>
                                <canvas id="distributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stylist Analysis Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-user-friends me-2"></i>
                        スタイリスト別リピート分析
                    </h3>
                    <p class="section-description">
                        このセクションでは、各スタイリストの顧客維持能力を分析しています。
                        {{ parameters.min_repeat_count }}回以上リピート率: 各スタイリストが初回担当した顧客のうち、{{ parameters.min_repeat_count }}回以上リピートした（合計{{ parameters.min_repeat_count + 1 }}回以上来店した）顧客の割合です。
                        ※新規顧客数が少ないスタイリスト（{{ data.stylist_charts.summary.min_customers_filter }}人未満）は比較対象から除外しています。
                    </p>
                </div>
                
                <div class="card-body">
                    <!-- Summary Stats -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="alert alert-info">
                                <h6 class="mb-1">トップスタイリスト</h6>
                                <strong>{{ data.stylist_charts.summary.top_stylist.name }}</strong><br>
                                <small>{{ parameters.min_repeat_count }}回以上リピート率: {{ data.stylist_charts.summary.top_stylist.rate }}%</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-success">
                                <h6 class="mb-1">{{ parameters.min_repeat_count }}回以上リピーター数（全体）</h6>
                                <strong>{{ data.stylist_charts.summary.total_x_plus_repeaters }}人</strong>
                            </div>
                        </div>
                    </div>
                    
                    {% if data.stylist_charts.rate_chart %}
                    <div class="chart-container" id="stylistRateChartContainer">
                        <h5 class="chart-title">スタイリスト別{{ parameters.min_repeat_count }}回以上リピート率</h5>
                        <canvas id="stylistRateChart"></canvas>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        条件を満たすスタイリストデータがありません（最低{{ data.stylist_charts.summary.min_customers_filter }}人の新規顧客が必要）
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Coupon Analysis Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-ticket-alt me-2"></i>
                        クーポン別リピート分析
                    </h3>
                    <p class="section-description">
                        このセクションでは、初回来店時に使用されたクーポンと顧客リピート状況を分析しています。
                        この分析により、どのクーポンで来店した顧客が最も継続して来店するかを判断でき、効果的なクーポン施策の立案に役立ちます。
                        ※利用顧客数が少ないクーポン（{{ data.coupon_charts.summary.min_customers_filter }}人未満）は比較対象から除外しています。
                    </p>
                </div>
                
                <div class="card-body">
                    <!-- Summary Stats -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="alert alert-warning">
                                <h6 class="mb-1">最も効果的なクーポン</h6>
                                <strong>{{ data.coupon_charts.summary.best_coupon.name }}</strong><br>
                                <small>{{ parameters.min_repeat_count }}回以上リピート率: {{ data.coupon_charts.summary.best_coupon.rate }}%</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-info">
                                <h6 class="mb-1">平均リピート回数</h6>
                                <strong>{{ data.coupon_charts.summary.best_coupon.avg_repeat }}回</strong><br>
                                <small>（上記クーポンのリピーターのみ）</small>
                            </div>
                        </div>
                    </div>
                    
                    {% if data.coupon_charts.rate_chart %}
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="chart-container" id="couponRateChartContainer">
                                <h5 class="chart-title">クーポン別{{ parameters.min_repeat_count }}回以上リピート率</h5>
                                <canvas id="couponRateChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <div class="chart-container" id="couponRepeatChartContainer">
                                <h5 class="chart-title">クーポン別平均リピート回数</h5>
                                <canvas id="couponRepeatChart"></canvas>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        条件を満たすクーポンデータがありません（最低{{ data.coupon_charts.summary.min_customers_filter }}人の利用顧客が必要）
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Target Comparison Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-bullseye me-2"></i>
                        目標値比較分析
                    </h3>
                    <p class="section-description">
                        このセクションでは、店舗が設定したリピート率の目標値と実績を比較し、目標達成に必要な具体的な顧客数を分析しています。
                    </p>
                </div>
                
                <div class="card-body">
                    <!-- Overall Achievement -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="alert alert-primary">
                                <h6 class="mb-1">全体目標達成率</h6>
                                <strong>{{ data.target_charts.summary.overall_achievement }}%</strong>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comparison Chart -->
                    <div class "row mb-4">
                        <div class="col-12">
                            <div class="chart-container" id="targetComparisonChartContainer">
                                <h5 class="chart-title">リピート段階別 目標と実績</h5>
                                <canvas id="targetComparisonChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comparison Tables -->
                    <div class="row">
                        <div class="col-lg-6">
                            <h6>実績と目標値の比較</h6>
                            <div class="table-responsive">
                                <table class="table table-custom">
                                    <thead>
                                        <tr>
                                            <th>リピート段階</th>
                                            <th>目標値</th>
                                            <th>実績値</th>
                                            <th>目標達成率</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in data.summary_tables.target_comparison_table %}
                                        <tr>
                                            <td>{{ row.stage }}</td>
                                            <td>{{ row.target_rate }}</td>
                                            <td>{{ row.actual_rate }}</td>
                                            <td>{{ row.achievement_rate }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <h6>目標達成に必要な追加顧客数</h6>
                            <div class="table-responsive">
                                <table class="table table-custom">
                                    <thead>
                                        <tr>
                                            <th>リピート段階</th>
                                            <th>目標顧客数</th>
                                            <th>現在の顧客数</th>
                                            <th>追加で必要な顧客数</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in data.summary_tables.additional_customers_table %}
                                        <tr>
                                            <td>{{ row.stage }}</td>
                                            <td>{{ row.target_count }}人</td>
                                            <td>{{ row.current_count }}人</td>
                                            <td>{{ row.additional_needed }}人</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Period Analysis Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-clock me-2"></i>
                        リピートまでの期間分析
                    </h3>
                    <p class="section-description">
                        初回来店から初回リピートまでの期間を分析し、顧客エンゲージメントのタイミングを把握します。
                    </p>
                </div>
                
                <div class="card-body">
                    <!-- Summary Stats -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h5 class="text-primary">{{ data.period_charts.summary.avg_days }}日</h5>
                                <small class="text-muted">平均初回リピート日数</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h5 class="text-success">{{ data.period_charts.summary.median_days }}日</h5>
                                <small class="text-muted">中央値初回リピート日数</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h5 class="text-info">{{ data.period_charts.summary.min_days }}日</h5>
                                <small class="text-muted">最短初回リピート日数</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h5 class="text-warning">{{ data.period_charts.summary.max_days }}日</h5>
                                <small class="text-muted">最長初回リピート日数</small>
                            </div>
                        </div>
                    </div>
                    
                    {% if data.period_charts.period_chart %}
                    <div class="row">
                        <div class="col-md-8 mx-auto">
                            <div class="chart-container" id="periodDistributionChartContainer">
                                <h5 class="chart-title">初回リピートまでの期間分布</h5>
                                <canvas id="periodDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Trends Section -->
    <!--
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-chart-line me-2"></i>
                        月別トレンド分析
                    </h3>
                    <p class="section-description">
                        新規顧客獲得とリピート率の月別推移を分析し、季節性やトレンドを把握します。
                    </p>
                </div>
                
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="chart-container" id="monthlyNewChartContainer">
                                <h5 class="chart-title">月別新規顧客数推移</h5>
                                <canvas id="monthlyNewChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <div class="chart-container" id="monthlyRepeatChartContainer">
                                <h5 class="chart-title">月別初回リピート率推移</h5>
                                <canvas id="monthlyRepeatChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    -->

    <!-- Monthly Trend Analysis Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-chart-line me-2"></i>
                        月次トレンド分析
                    </h3>
                    <p class="section-description">
                        新規顧客獲得月別のリピート状況の推移を分析します。
                    </p>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="chart-container" id="monthlyNewCustomersChartContainer">
                                <h5 class="chart-title">月別新規顧客数とリピート顧客数</h5>
                                <canvas id="monthlyNewCustomersChart"></canvas>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="chart-container" id="monthlyRepeatRateChartContainer">
                                <h5 class="chart-title">月別リピート率</h5>
                                <canvas id="monthlyRepeatRateChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Tables Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="section-header">
                    <h3 class="section-title">
                        <i class="fas fa-table me-2"></i>
                        詳細データテーブル
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs" id="summaryTableTabs" role="tablist">
                        {% if data.summary_tables.stylist_table %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="stylist-table-tab" data-bs-toggle="tab" data-bs-target="#stylistTableContent" type="button" role="tab">スタイリスト別詳細</button>
                        </li>
                        {% endif %}
                        {% if data.summary_tables.coupon_table %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link {% if not data.summary_tables.stylist_table %}active{% endif %}" id="coupon-table-tab" data-bs-toggle="tab" data-bs-target="#couponTableContent" type="button" role="tab">クーポン別詳細</button>
                        </li>
                        {% endif %}
                    </ul>

                    <!-- Tab panes -->
                    <div class="tab-content mt-3">
                        {% if data.summary_tables.stylist_table %}
                        <div class="tab-pane fade show active" id="stylistTableContent" role="tabpanel">
                            <h5>スタイリスト別リピート分析 詳細</h5>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            {% for header in data.summary_tables.stylist_table.headers %}
                                            <th>{{ header }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in data.summary_tables.stylist_table.rows %}
                                        <tr>
                                            {% for cell in row %}
                                            <td>{{ cell }}</td>
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                        {% if data.summary_tables.coupon_table %}
                        <div class="tab-pane fade {% if not data.summary_tables.stylist_table %}show active{% endif %}" id="couponTableContent" role="tabpanel">
                            <h5>クーポン別リピート分析 詳細</h5>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            {% for header in data.summary_tables.coupon_table.headers %}
                                            <th>{{ header }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in data.summary_tables.coupon_table.rows %}
                                        <tr>
                                            {% for cell in row %}
                                            <td>{{ cell }}</td>
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // chartjs-plugin-datalabels をグローバルに登録
    if (typeof ChartDataLabels !== 'undefined') {
        Chart.register(ChartDataLabels);
    } else {
        console.error("ChartDataLabels plugin is not loaded.");
    }

    const chartData = {{ data | tojson }};
    const parameters = {{ parameters | tojson }};

    const getCtx = (id) => document.getElementById(id)?.getContext('2d');

    function initializeChart(canvasId, chartConfig) {
        const ctx = getCtx(canvasId);
        const container = document.getElementById(canvasId + 'Container');

        if (!ctx || !container) {
            console.warn(`Chart canvas or container not found for: ${canvasId}`);
            return;
        }

        if (chartConfig && chartConfig.data && chartConfig.data.datasets && chartConfig.data.datasets.some(ds => ds.data && ds.data.length > 0)) {
            // console.log(`Initializing chart: ${canvasId} with config:`, JSON.parse(JSON.stringify(chartConfig))); // 循環参照を避けるために一度stringify/parse
            try {
                new Chart(ctx, {
                    type: chartConfig.type,
                    data: chartConfig.data,
                    options: chartConfig.options
                });
            } catch (e) {
                console.error(`Error initializing chart ${canvasId}:`, e, JSON.parse(JSON.stringify(chartConfig)));
                container.innerHTML = `<div class="alert alert-danger text-center p-3"><i class="fas fa-exclamation-triangle me-1"></i>グラフの表示中にエラーが発生しました。(${canvasId})</div>`;
            }
        } else {
            console.warn(`Chart not initialized (config, data, or datasets missing or empty): ${canvasId}`, JSON.parse(JSON.stringify(chartConfig || {})));
            container.innerHTML = `<div class="alert alert-light text-center p-3"><i class="fas fa-info-circle me-1"></i>表示できるデータがありません。(${canvasId})</div>`;
        }
    }

    // --- Funnel Charts ---
    if (chartData.funnel_charts) {
        const funnelCharts = chartData.funnel_charts;

        if (funnelCharts.stage_chart) {
            funnelCharts.stage_chart.options = funnelCharts.stage_chart.options || {};
            funnelCharts.stage_chart.options.plugins = funnelCharts.stage_chart.options.plugins || {};
            funnelCharts.stage_chart.options.plugins.datalabels = {
                display: true,
                align: 'end',
                anchor: 'end',
                color: '#444',
                font: { weight: 'bold' },
                formatter: function(value) {
                    if (value === null || typeof value === 'undefined') return '';
                    return Math.round(value);
                }
            };
            initializeChart('stageChart', funnelCharts.stage_chart);
        }

        if (funnelCharts.continuation_chart) {
            funnelCharts.continuation_chart.options = funnelCharts.continuation_chart.options || {};
            funnelCharts.continuation_chart.options.plugins = funnelCharts.continuation_chart.options.plugins || {};
            funnelCharts.continuation_chart.options.plugins.datalabels = {
                display: true,
                align: 'end',
                anchor: 'end',
                color: '#444',
                font: { weight: 'bold' },
                formatter: function(value) {
                    if (value === null || typeof value === 'undefined') return '';
                    return parseFloat(value).toFixed(1) + '%';
                }
            };
            initializeChart('continuationChart', funnelCharts.continuation_chart);
        }

        if (funnelCharts.distribution_chart) {
            // トップレベルの datalabels 設定 (ここでは主に display: false か、共通スタイル)
            funnelCharts.distribution_chart.options = funnelCharts.distribution_chart.options || {};
            funnelCharts.distribution_chart.options.plugins = funnelCharts.distribution_chart.options.plugins || {};
            funnelCharts.distribution_chart.options.plugins.datalabels = {
                display: false, // 各データセットで制御
            };
            // データセットごとのフォーマッタ設定
            if (funnelCharts.distribution_chart.data && funnelCharts.distribution_chart.data.datasets) {
                funnelCharts.distribution_chart.data.datasets.forEach(dataset => {
                    if (dataset.label === '顧客数') {
                        dataset.datalabels = {
                            display: true,
                            align: 'end',
                            anchor: 'end',
                            color: '#444',
                            font: { weight: 'bold' },
                            formatter: function(value) {
                                if (value === null || typeof value === 'undefined') return '';
                                return Math.round(value);
                            }
                        };
                    } else if (dataset.label === '累積割合 (%)') {
                        dataset.datalabels = {
                            display: true,
                            align: 'top',
                            anchor: 'end',
                            color: '#444',
                            font: { weight: 'bold' },
                            backgroundColor: 'rgba(255, 255, 255, 0.7)',
                            borderRadius: 4,
                            padding: 4,
                            formatter: function(value) {
                                if (value === null || typeof value === 'undefined') return '';
                                return parseFloat(value).toFixed(1) + '%';
                            }
                        };
                    }
                });
            }
            initializeChart('distributionChart', funnelCharts.distribution_chart);
        }
    }

    // --- Stylist Charts ---
    if (chartData.stylist_charts && chartData.stylist_charts.rate_chart) {
        const stylistChartConfig = chartData.stylist_charts.rate_chart;
        stylistChartConfig.options = stylistChartConfig.options || {};
        stylistChartConfig.options.plugins = stylistChartConfig.options.plugins || {};
        stylistChartConfig.options.plugins.datalabels = {
            display: true,
            align: 'end',
            anchor: 'end',
            color: '#444',
            font: { weight: 'bold' },
            formatter: function(value) {
                if (value === null || typeof value === 'undefined') return '';
                return parseFloat(value).toFixed(1) + '%'; // X回以上リピート率
            }
        };
        initializeChart('stylistRateChart', stylistChartConfig);
    }
    
    // --- Coupon Charts ---
    if (chartData.coupon_charts) {
        if (chartData.coupon_charts.rate_chart) {
            const couponRateChartConfig = chartData.coupon_charts.rate_chart;
            couponRateChartConfig.options = couponRateChartConfig.options || {};
            couponRateChartConfig.options.plugins = couponRateChartConfig.options.plugins || {};
            couponRateChartConfig.options.plugins.datalabels = {
                // display: true, // 関数で制御するためコメントアウトまたは削除
                align: 'end',
                anchor: 'end',
                color: '#444',
                font: { weight: 'bold' },
                formatter: function(value) {
                    if (value === null || typeof value === 'undefined' || value === 0) return ''; // 0も非表示に
                    return parseFloat(value).toFixed(1) + '%';
                },
                display: function(context) {
                    const dataset = context.dataset;
                    const currentValue = dataset.data[context.dataIndex];
                    if (currentValue === null || typeof currentValue === 'undefined' || currentValue === 0) {
                        return false;
                    }
                    // データセット内の値を降順ソートして上位3つの値を取得（重複はそのまま）
                    const sortedData = [...dataset.data].filter(val => val !== null && typeof val !== 'undefined').sort((a, b) => b - a);
                    const topValues = sortedData.slice(0, 3);
                    // 現在の値が上位3つの値のいずれかと同じであれば表示 (ただし、データポイントが3つ未満の場合は全て表示)
                    if (dataset.data.filter(val => val !== null && typeof val !== 'undefined' && val > 0).length <= 3) {
                        return true;
                    }
                    return topValues.includes(currentValue);
                }
            };
            initializeChart('couponRateChart', couponRateChartConfig);
        }
        if (chartData.coupon_charts.repeat_chart) {
            const couponRepeatChartConfig = chartData.coupon_charts.repeat_chart;
            couponRepeatChartConfig.options = couponRepeatChartConfig.options || {};
            couponRepeatChartConfig.options.plugins = couponRepeatChartConfig.options.plugins || {};
            couponRepeatChartConfig.options.plugins.datalabels = {
                // display: true, // 関数で制御
                align: 'end',
                anchor: 'end',
                color: '#444',
                font: { weight: 'bold' },
                formatter: function(value) { 
                    if (value === null || typeof value === 'undefined' || value === 0) return '';
                    return parseFloat(value).toFixed(1) + '回'; 
                },
                display: function(context) {
                    const dataset = context.dataset;
                    const currentValue = dataset.data[context.dataIndex];
                    if (currentValue === null || typeof currentValue === 'undefined' || currentValue === 0) {
                        return false;
                    }
                    const sortedData = [...dataset.data].filter(val => val !== null && typeof val !== 'undefined').sort((a, b) => b - a);
                    const topValues = sortedData.slice(0, 3);
                    if (dataset.data.filter(val => val !== null && typeof val !== 'undefined' && val > 0).length <= 3) {
                        return true;
                    }
                    return topValues.includes(currentValue);
                }
            };
            initializeChart('couponRepeatChart', couponRepeatChartConfig);
        }
    }

    // --- Target Charts ---
    if (chartData.target_charts && chartData.target_charts.comparison_chart) {
        const targetChartConfig = chartData.target_charts.comparison_chart;
        targetChartConfig.options = targetChartConfig.options || {};
        targetChartConfig.options.plugins = targetChartConfig.options.plugins || {};
        targetChartConfig.options.plugins.datalabels = {
             display: false // 複合グラフなのでデータセットごとに設定
        };
        if (targetChartConfig.data && targetChartConfig.data.datasets) {
            targetChartConfig.data.datasets.forEach(dataset => {
                dataset.datalabels = {
                    display: true,
                    align: 'center', // 中央が見やすいことが多い
                    anchor: 'center',
                    color: dataset.type === 'line' ? '#222' : '#fff', // 線グラフは暗色、棒グラフは明色
                    font: { weight: 'bold' },
                    formatter: function(value) {
                        if (value === null || typeof value === 'undefined') return '';
                        // 「目標顧客数」と「実績顧客数」は整数、「目標リピート率」と「実績リピート率」は%
                        if (dataset.label.includes('率')) {
                            return parseFloat(value).toFixed(1) + '%';
                        } else if (dataset.label.includes('数')) {
                            return Math.round(value);
                        }
                        return parseFloat(value).toFixed(1); // デフォルト
                    }
                };
            });
        }
        initializeChart('targetComparisonChart', targetChartConfig);
    }

    // --- Period Charts ---
    const periodChartContainer = document.getElementById('periodDistributionChartContainer');
    if (chartData.period_charts && chartData.period_charts.period_chart) {
        const periodChartConfig = chartData.period_charts.period_chart;
        console.log('[DEBUG] periodDistributionChart - Config:', JSON.parse(JSON.stringify(periodChartConfig || {})));
        if (periodChartConfig && periodChartConfig.options && periodChartConfig.options.plugins) {
            periodChartConfig.options.plugins.datalabels = {
                display: true,
                align: 'end',
                anchor: 'end',
                color: '#444',
                font: { weight: 'bold' },
                formatter: function(value) {
                    if (value === null || typeof value === 'undefined') return '';
                    return Math.round(value);
                }
            };
        } else if (periodChartConfig) {
             // Configはあるがoptionsやpluginsがない場合、初期化
            periodChartConfig.options = periodChartConfig.options || {};
            periodChartConfig.options.plugins = periodChartConfig.options.plugins || {};
            periodChartConfig.options.plugins.datalabels = { /* 上記と同様のformatter */ display: true, align: 'end', anchor: 'end', color: '#444', font: {weight: 'bold'}, formatter: function(value) {if (value === null || typeof value === 'undefined') return ''; return Math.round(value);} };
        }
        initializeChart('periodDistributionChart', periodChartConfig);
    } else {
        console.log('[DEBUG] periodDistributionChart - Config not found. chartData.period_charts:', JSON.parse(JSON.stringify(chartData.period_charts || {})));
        if (periodChartContainer) {
            periodChartContainer.innerHTML = `<div class="alert alert-light text-center p-3"><i class="fas fa-info-circle me-1"></i>グラフ設定が見つかりません (periodDistributionChart)。</div>`;
        }
    }
    
    // --- Monthly Charts ---
    const monthlyNewCustomersChartContainer = document.getElementById('monthlyNewCustomersChartContainer');
    const monthlyRepeatRateChartContainer = document.getElementById('monthlyRepeatRateChartContainer');

    if (chartData.monthly_charts) {
        if (chartData.monthly_charts.new_customers_chart) {
            const monthlyNewVsRepeatConfig = chartData.monthly_charts.new_customers_chart;
            console.log('[DEBUG] monthlyNewCustomersChart - Config:', JSON.parse(JSON.stringify(monthlyNewVsRepeatConfig || {})));
            if (monthlyNewVsRepeatConfig && monthlyNewVsRepeatConfig.options && monthlyNewVsRepeatConfig.options.plugins) {
                monthlyNewVsRepeatConfig.options.plugins.datalabels = {
                    display: false // データセットごとに設定するため基本はfalse
                };
                 if (monthlyNewVsRepeatConfig.data && monthlyNewVsRepeatConfig.data.datasets) {
                    monthlyNewVsRepeatConfig.data.datasets.forEach(dataset => {
                        dataset.datalabels = {
                            display: true,
                            align: 'end',
                            anchor: 'end',
                            color: '#444',
                            font: { weight: 'bold' },
                            formatter: function(value) { // 新規顧客数、リピート顧客数
                                if (value === null || typeof value === 'undefined') return '';
                                return Math.round(value);
                            }
                        };
                    });
                }
            } else if (monthlyNewVsRepeatConfig) {
                monthlyNewVsRepeatConfig.options = monthlyNewVsRepeatConfig.options || {};
                monthlyNewVsRepeatConfig.options.plugins = monthlyNewVsRepeatConfig.options.plugins || {};
                monthlyNewVsRepeatConfig.options.plugins.datalabels = {display: false};
                 if (monthlyNewVsRepeatConfig.data && monthlyNewVsRepeatConfig.data.datasets) { /*上記と同様のdataset formatter*/ monthlyNewVsRepeatConfig.data.datasets.forEach(dataset => {dataset.datalabels = {display: true, align: 'end', anchor: 'end', color: '#444', font: {weight: 'bold'}, formatter: function(value) {if (value === null || typeof value === 'undefined') return ''; return Math.round(value);}};});}
            }
            initializeChart('monthlyNewCustomersChart', monthlyNewVsRepeatConfig);
        } else {
            console.log('[DEBUG] monthlyNewCustomersChart - Config not found. chartData.monthly_charts:', JSON.parse(JSON.stringify(chartData.monthly_charts || {})));
            if (monthlyNewCustomersChartContainer) {
                monthlyNewCustomersChartContainer.innerHTML = `<div class="alert alert-light text-center p-3"><i class="fas fa-info-circle me-1"></i>グラフ設定が見つかりません (monthlyNewCustomersChart)。</div>`;
            }
        }

        if (chartData.monthly_charts.repeat_rate_chart) {
            const monthlyRateConfig = chartData.monthly_charts.repeat_rate_chart;
            console.log('[DEBUG] monthlyRepeatRateChart - Config:', JSON.parse(JSON.stringify(monthlyRateConfig || {})));
            if (monthlyRateConfig && monthlyRateConfig.options && monthlyRateConfig.options.plugins) {
                monthlyRateConfig.options.plugins.datalabels = {
                    display: true,
                    align: 'top',
                    anchor: 'end',
                    color: '#444',
                    font: { weight: 'bold' },
                    backgroundColor: 'rgba(255, 255, 255, 0.7)',
                    borderRadius: 4,
                    padding: 3,
                    formatter: function(value) { // リピート率
                        if (value === null || typeof value === 'undefined') return '';
                        return parseFloat(value).toFixed(1) + '%';
                    }
                };
            } else if (monthlyRateConfig) {
                monthlyRateConfig.options = monthlyRateConfig.options || {};
                monthlyRateConfig.options.plugins = monthlyRateConfig.options.plugins || {};
                monthlyRateConfig.options.plugins.datalabels = { /* 上記と同様のformatter */ display: true, align: 'top', anchor: 'end', color: '#444', font: {weight: 'bold'}, backgroundColor: 'rgba(255,255,255,0.7)', borderRadius: 4, padding: 3, formatter: function(value) {if (value === null || typeof value === 'undefined') return ''; return parseFloat(value).toFixed(1) + '%';} };
            }
            initializeChart('monthlyRepeatRateChart', monthlyRateConfig);
        } else {
            console.log('[DEBUG] monthlyRepeatRateChart - Config not found. chartData.monthly_charts:', JSON.parse(JSON.stringify(chartData.monthly_charts || {})));
            if (monthlyRepeatRateChartContainer) {
                monthlyRepeatRateChartContainer.innerHTML = `<div class="alert alert-light text-center p-3"><i class="fas fa-info-circle me-1"></i>グラフ設定が見つかりません (monthlyRepeatRateChart)。</div>`;
            }
        }
    } else {
        console.log('[DEBUG] chartData.monthly_charts itself is not defined.');
        if (monthlyNewCustomersChartContainer) monthlyNewCustomersChartContainer.innerHTML = `<div class="alert alert-light text-center p-3"><i class="fas fa-info-circle me-1"></i>月次データ未生成 (monthlyNewCustomersChart)。</div>`;
        if (monthlyRepeatRateChartContainer) monthlyRepeatRateChartContainer.innerHTML = `<div class="alert alert-light text-center p-3"><i class="fas fa-info-circle me-1"></i>月次データ未生成 (monthlyRepeatRateChart)。</div>`;
    }
    
    // Export functionality (if not already in app.js)
    window.Export = {
        downloadReport: function() {
            // Add timestamp to prevent caching issues if any
            window.location.href = '{{ url_for("generate_report") }}?t=' + new Date().getTime();
        }
    };
});
</script>
{% endblock %} 