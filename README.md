# 美容室顧客データリピート分析システム

美容室の顧客データを用いて、新規顧客のリピート状況を多角的に分析し、インタラクティブなダッシュボード形式で可視化するFlask Webアプリケーションです。

## 機能概要

### 主要機能
- **CSVファイルアップロード**: 複数ファイルの同時アップロード対応。エンコーディング自動判定 (UTF-8, Shift_JISなど)。
- **データクレンジング**:
    - 日付形式の自動認識・統一 (様々な一般的な日付形式に対応)。
    - ステータスフィルター (例: 「済み」の予約のみ対象)。
    - 顧客情報の正規化と高度な顧客同定ロジック。
    - 「このサロンに行くのは初めてですか？」のようなフラグカラムの適切なブール値への変換。
- **リピート分析**:
    - 新規顧客の明確な定義に基づいた抽出。
    - 多角的な分析（ファネル、スタイリスト別、クーポン別、目標比較、期間別、月別トレンドなど）。
    - Pandasを活用した効率的な分析処理。
- **インタラクティブダッシュボード**: Chart.js (v3以降対応) を使用したリッチな可視化。
- **レポート出力**: 詳細なテキストレポートの生成・ダウンロード。堅牢なデータアクセス処理。

### 分析項目
1.  **顧客リピート状況概要**
    - 新規顧客総数
    - X回以上リピーター数・率
    - 初回リピート率
    - 平均リピート回数（全顧客・リピーター別）

2.  **リピートファネル分析**
    - ステージ別顧客数と全体に対する割合
    - ステージ間継続率
    - リピート回数分布と累積割合

3.  **スタイリスト別分析**
    - スタイリストごとのリピート率、担当顧客数など
    - トップパフォーミングスタイリストの特定

4.  **クーポン別分析**
    - クーポンごとのリピート貢献度、平均リピート回数など
    - 最も効果的なクーポンの特定

5.  **目標値比較分析** (目標値は現在サーバーサイドで固定)
    - 各リピート段階の目標値と実績の比較
    - 目標達成率、目標達成に必要な追加顧客数

6.  **期間分析**
    - 初回リピートまでの平均・中央値・最短・最長日数
    - リピートまでの期間区分別分布

7.  **月別トレンド分析**
    - 月別の新規顧客数
    - 月別の初回リピート率

## 技術スタック

- **Backend**: Python 3.12, Flask (最新安定版を推奨)
- **Data Processing**: Pandas, NumPy
- **Visualization**: Chart.js (v3以降)
- **Frontend**: Bootstrap 5, HTML5, JavaScript (ES6)
- **File Handling**: chardet (エンコーディング自動判定)
- **その他**: 標準ライブラリ (os, pickle, uuid, json, datetime, traceback, logging)

## セットアップ

### 前提条件
- Python 3.12以上
- pip (Python パッケージインストーラー)

### インストール手順

1.  **リポジトリのクローン**
    ```bash
    git clone <repository-url>
    cd hpb-repeat-analyzer
    ```

2.  **仮想環境の作成・有効化** (推奨)
    ```bash
    python -m venv .venv
    # Windows
    .venv\\Scripts\\activate
    # macOS/Linux
    source .venv/bin/activate
    ```

3.  **依存関係のインストール**
    ```bash
    pip install -r requirements.txt
    ```

4.  **アプリケーションの起動**
    ```bash
    flask run
    # もしくはポートを指定して起動
    # flask run --port=5001
    ```
    開発サーバーが起動し、アクセス可能なURLが表示されます (通常 `http://127.0.0.1:5000` または指定したポート)。

5.  **ブラウザでアクセス**
    表示されたURLにウェブブラウザでアクセスします。

## 使用方法

### 1. CSVファイルのアップロード
- 分析対象の来店履歴データ（CSV形式）を画面から選択します。
- 複数ファイルの同時アップロードに対応しています。
- アップロード後、システムが自動でデータを処理し、分析可能な状態にします。

### 2. 分析設定
- **新規顧客抽出期間**: 新規顧客として定義する来店日の範囲を指定します (データ内の最初の日付と最後の日付が自動で入力されます)。
- **リピート集計終了日**: どの時点までのリピート行動を集計対象とするかを指定します (データ内の最後の日付が自動で入力されます)。
- **分析パラメータ**: 詳細な分析の閾値（例: X回以上リピートのXの値、スタイリスト分析対象の最低顧客数など）を設定します。
- 注意: リピート率の目標値は現在サーバーサイドで固定値 (初回35%, 2回目45%, 3回目60%) が使用されます。

### 3. 結果の確認
- **ダッシュボード**: 「分析実行」ボタン押下後、自動的にダッシュボード画面に遷移し、多角的な分析結果をインタラクティブなグラフや表で確認できます。
- **レポート出力**: ダッシュボード画面からテキスト形式の詳細レポートをダウンロードできます。

## データ形式

### 必要な主要CSVカラム
- **`ステータス`**: 予約状態を示します。分析対象は主に「済み」のデータです。
- **`来店日`**: 顧客の来店日。様々な一般的な日付形式に対応 (例: YYYY-MM-DD, YYYY/MM/DD, YYYYMMDD)。
- **`このサロンに行くのは初めてですか？`**: 新規顧客かどうかを示すフラグ。「True/False」や「はい/いいえ」などの文字列をブール値として解釈します。
- **`スタイリスト名`**: 担当したスタイリストの名前。
- **`予約時HotPepperBeautyクーポン`**: 利用したクーポンの名称。
- **`予約時合計金額`**: 支払金額。
- **`性別`**: 顧客の性別。
- **`予約時メニュー`**: 利用したメニュー。
- 顧客同定に使用するカラム: `電話番号`, `フリガナ`, `お名前`, `氏名(カナ)`, `氏名(漢字)`, `お客様番号`など。システムはこれらの情報を組み合わせて顧客を識別します。

### データクレンジング機能
本システムは、アップロードされたデータに対して以下のクレンジング処理を自動で行います:
- 文字列データの正規化 (例: 不要な空白の除去、表記揺れの統一)。
- 電話番号の正規化。
- 複数の名前関連情報や電話番号を基にした高度な顧客IDの生成と名寄せ。
- 日付データのパースと型変換。
- 売上データの数値化。
- 必要なフラグ値のブール型への変換。

## プロジェクト構造

```
hpb-repeat-analyzer/
├── app.py                 # Flaskメインアプリケーションファイル
├── requirements.txt       # Python依存パッケージリスト
├── README.md              # このファイル
├── test_modules.py        # モジュールテスト用スクリプト
├── modules/               # コアロジックモジュール群
│   ├── __init__.py
│   ├── data_processor.py    # CSV読み込み、データクレンジング、顧客同定
│   ├── repeat_analyzer.py   # リピート分析ロジック
│   ├── visualization.py     # ダッシュボード用データ生成
│   └── report_generator.py  # テキストレポート生成
├── templates/             # HTMLテンプレートファイル
│   ├── base.html            # ベースレイアウト
│   ├── index.html           # アップロード・設定ページ
│   ├── dashboard.html       # 分析結果表示ダッシュボード
│   └── error.html           # エラー表示ページ
├── static/                # 静的ファイル (CSS, JavaScript, 画像など)
│   ├── css/
│   │   └── style.css      # メインスタイルシート
│   └── js/
│       └── app.js         # フロントエンドJavaScript
├── uploads/               # アップロードされたCSVファイルの一時保存場所 (処理後に削除されることも)
├── processed_data/        # DataProcessorによって処理・pickle化されたデータの一時保存場所
├── reports/               # 生成されたテキストレポートの保存場所
└── docs/                  # ドキュメント関連 (現在は requirements.md のみ)
    └── requirements.md    # (旧)要件定義書
```

## データフロー概要

1.  **ファイルアップロード (`/upload`):**
    *   ユーザーが `index.html` からCSVファイルをアップロードします。
    *   `app.py` の `/upload` ルートがリクエストを処理します。
    *   `DataProcessor` モジュールがCSVファイルを読み込み、結合、クレンジング処理（エンコーディング検出、日付パース、顧客同定など）を行います。
    *   処理済みのDataFrameは一意な名前で `processed_data/` フォルダにpickleファイルとして一時保存されます。
    *   このpickleファイルのパスと、データセット全体の日付範囲 (`min_date`, `max_date`) がFlaskのセッションに格納されます。
2.  **分析実行 (`/analyze`):**
    *   ユーザーが `index.html` で分析パラメータ（新規顧客期間、リピート集計終了日など）を設定し、分析実行ボタンを押します。
    *   `app.py` の `/analyze` ルートがリクエストを処理します。
    *   セッションから処理済みデータのファイルパスを読み込み、pickleファイルからDataFrameを復元します。
    *   `RepeatAnalyzer` モジュールが、復元されたDataFrameとユーザー指定パラメータを用いてリピート分析を実行します。目標値はサーバーサイドで定義された固定値が使用されます。
    *   生成された分析結果 (詳細な辞書データ) は、一意な名前で `processed_data/` フォルダに別のpickleファイルとして一時保存されます。
    *   この分析結果pickleファイルのパスと、使用された分析パラメータがセッションに格納されます。
    *   成功すると、クライアントは `/dashboard` へリダイレクトされます。
3.  **ダッシュボード表示 (`/dashboard`):**
    *   `app.py` の `/dashboard` ルートがリクエストを処理します。
    *   セッションから分析結果のファイルパスと分析パラメータを読み込み、pickleファイルから分析結果データを復元します。
    *   `DashboardVisualizer` モジュールが、復元された分析結果を元にダッシュボード表示用のデータ構造を生成します。
    *   生成されたデータとパラメータが `dashboard.html` テンプレートに渡され、Chart.jsを用いてグラフや表としてレンダリングされます。
4.  **レポート生成 (`/report`):**
    *   ユーザーがダッシュボード上のボタンからレポートダウンロードを要求します。
    *   `app.py` の `/report` ルートがリクエストを処理します。
    *   セッションから分析結果のファイルパスと分析パラメータを読み込み、pickleファイルから分析結果データを復元します。
    *   `ReportGenerator` モジュールが、復元された分析結果とパラメータを用いて詳細なテキストレポートを生成します。
    *   生成されたレポートはユーザーにダウンロードファイルとして提供されます。

## テスト
主要モジュール (`DataProcessor`, `RepeatAnalyzer`, `DashboardVisualizer`, `ReportGenerator`) の機能を検証するためのテストスイートが提供されています。
以下のコマンドでテストを実行できます:
```bash
python test_modules.py
```
テストは、様々なシナリオ（正常系、異常系、境界値など）をカバーし、コードの品質と安定性を維持するのに役立ちます。

## 設定

### アプリケーション設定 (`app.py` 内)
- **`SECRET_KEY`**: Flaskセッション管理のための秘密鍵。本番環境では必ず複雑でユニークなキーに変更してください。
- **`UPLOAD_FOLDER`**: アップロードされたファイルの一時保存ディレクトリ (デフォルト: `uploads/`)。
- **`PROCESSED_DATA_FOLDER`**: 処理済みデータや分析結果のpickleファイルの一時保存ディレクトリ (デフォルト: `processed_data/`)。
- **`MAX_CONTENT_LENGTH`**: アップロード可能なファイルの最大サイズ (デフォルト: 100MB)。

### 分析パラメータ (UIまたはサーバーサイドで設定)
- **`min_repeat_count`**: 「X回以上リピート」の基準となるXの値 (デフォルト: 3回)。
- **`min_stylist_customers`**: スタイリスト別分析で、分析対象とするために必要な最低担当新規顧客数 (デフォルト: 10人)。
- **`min_coupon_customers`**: クーポン別分析で、分析対象とするために必要な最低利用新規顧客数 (デフォルト: 5人)。
- **リピート目標値**: 初回35%, 2回目45%, 3回目60% (現在サーバーサイドで固定)。

## トラブルシューティング

### よくある問題と対処法

1.  **CSVファイルが読み込めない / 文字化けする**
    *   **原因**: ファイルエンコーディングが特殊、またはシステムが対応していない形式。ファイル内容の不備。
    *   **対処法**: CSVファイルをUTF-8またはShift_JIS形式で保存し直してみてください。必須カラム（来店日、ステータスなど）が存在するか、データ形式が大きく崩れていないか確認してください。

2.  **新規顧客が正しく抽出されない / リピート率がおかしい**
    *   **原因**: 「新規顧客抽出期間」の設定ミス。「このサロンに行くのは初めてですか？」カラムのデータ不備または解釈不可能な値。来店データの「ステータス」が「済み」になっていない。
    *   **対処法**: 分析設定画面で期間が正しく設定されているか確認してください。「このサロンに行くのは初めてですか？」カラムの値が「はい」「いいえ」「True」「False」などのシステムが解釈可能な値になっているか確認してください。

3.  **分析結果が表示されない / エラーページが表示される**
    *   **原因**: アップロードデータの品質に問題がある（例: 数値であるべきカラムに文字列が多い、日付が極端に少ないなど）。設定した分析パラメータ（最低顧客数など）に対してデータ量が少なすぎる。サーバー側で予期せぬエラーが発生した。
    *   **対処法**: より多くの、または品質の高いデータで試してみてください。分析パラメータの閾値を調整してみてください。Flaskサーバーのコンソールログにエラーメッセージが出力されていないか確認してください。

### ログ出力
アプリケーションは実行中に主要な処理ステップやエラー情報をコンソールにログとして出力します。問題が発生した場合は、まずこれらのログを確認することで原因究明の手がかりが得られます。

## 今後の改善点 (検討事項)
- `test_modules.py` のテストカバレッジ向上、特にShift_JISエンコーディングのテストデータにおける分析カラムの拡充。
- `ReportGenerator` モジュールにCSV/Excel形式でのエクスポート機能を追加。
- UI/UXのさらなる改善 (例: プログレスバー表示、詳細なエラーフィードバック)。
- パフォーマンスチューニング (特に大規模データセットを扱う場合)。

## ライセンス
このプロジェクトは社内利用を想定しており、著作権は開発者に帰属します。

## サポート
技術的な問題や機能追加のご要望については、開発チームまでお問い合わせください。

---

**開発者**: HPB Repeat Analyzer Team